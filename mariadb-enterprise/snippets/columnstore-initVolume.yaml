# Copyright (c) 2018-2019 MariaDB Corporation Ab
# 
# Use of this software is governed by the Business Source License included
# in the LICENSE.TXT file and at www.mariadb.com/bsl11.
#
# Change Date: 2023-04-01
# 
# On the date above, in accordance with the Business Source License, use
# of this software will be governed by version 3 or later of the General
# Public License.

- name: init-volume
  image: {{ if and .Values.mariadb.cluster.imageRepo (not (regexMatch "^([-a-zA-Z0-9@:%._\\+~#=]{2,256}[.])+[-a-zA-Z0-9@:%._\\+~#=]{2,5}\\/" .Values.mariadb.columnstore.image)) }}{{ .Values.mariadb.cluster.imageRepo}}/{{ end }}{{ .Values.mariadb.columnstore.image }}
  command:
    - bash
    - "-c"
    - whoami;
          if [ $? -ne 0 ] && [ $(id -u) -ge 10000 ]; then
          RANDOM_USER=1;
          fi;
          set -e;
          if [ -n "$RANDOM_USER" ]; then
          cat /etc/passwd | sed -e "s/mysql:/builder:/" > /tmp/passwd;
          echo "mysql:x:$(id -u):$(id -g):,,,:/var/lib/mysql:/bin/bash" >> /tmp/passwd;
          cat /tmp/passwd > /etc/passwd;
          rm /tmp/passwd;
          fi; 
          if [ ! -d "/mnt/columnstore/etc" ]; then 
          rm -rf /mnt/columnstore/data;
          cp -rp /usr/local/mariadb/columnstore/data /mnt/columnstore/;
          rm -rf /mnt/columnstore/local;
          cp -rp /usr/local/mariadb/columnstore/local /mnt/columnstore/;
          rm -rf /mnt/columnstore/mysql;
          mkdir -p /mnt/columnstore/mysql;
          if [[ "$(whoami)" == "root" ]]; then
          chown mysql:mysql /mnt/columnstore/mysql;
          fi; 
          cp -rp /usr/local/mariadb/columnstore/mysql/db /mnt/columnstore/mysql/;
          cp -rp /usr/local/mariadb/columnstore/etc /mnt/columnstore/;
          fi
  volumeMounts:
    - name: data
      mountPath: /mnt/columnstore
